



# NMAP Quick Guide for Penetration Professionals

Nmap (Network Mapper) is a free and open-source network scanner designed to discover hosts and services on a computer network. When used by skilled penetration testers, it can be a very powerful tool to assess network vulnerabilities.

## Basic Usage:

```bash
nmap [Scan Type] [Options] {target specification}
```

## 1. Host Discovery

**Ping Scan (no port scan)**
```bash
nmap -sn <target>
```

**Don't ping, just scan**
```bash
nmap -Pn <target>
```

## 2. Scan Techniques

- **TCP SYN scan** (default for privileged users)
  ```bash
  nmap -sS <target>
  ```

- **TCP connect scan** (default for non-privileged users)
  ```bash
  nmap -sT <target>
  ```

- **UDP scan**
  ```bash
  nmap -sU <target>
  ```

- **SCTP INIT scan** (requires privileges)
  ```bash
  nmap -sY <target>
  ```

## 3. Port Specification

- **Specific Ports**
  ```bash
  nmap -p 22,80,443 <target>
  ```

- **Port Ranges**
  ```bash
  nmap -p 1-1000 <target>
  ```

- **All Ports**
  ```bash
  nmap -p- <target>
  ```

## 4. Version Detection

Attempt to determine the version of the service running on port:
```bash
nmap -sV <target>
```

## 5. OS Detection

Detect the operating system of the target:
```bash
nmap -O <target>
```

## 6. Timing and Performance

Timing templates can be used to speed up or slow down scanning based on the network environment.

- **Paranoid (0)**: Very slow, used to avoid IDS/IPS systems.
- **Sneaky (1)**
- **Polite (2)**
- **Normal (3)**
- **Aggressive (4)**
- **Insane (5)**: Extremely fast, but might miss some results.

```bash
nmap -T4 <target>
```

## 7. Scan using a Decoy

Spoof your IP with a decoy to obscure your machine's request:
```bash
nmap -D RND:10 <target>  # Randomizes decoys
nmap -D decoy1,decoy2,decoy3 <target>  # Manually set decoys
```

## 8. Scripting Engine

Nmap has a powerful scripting engine for advanced tasks. Nmap's Scripting Engine (NSE) allows users to write (or use pre-existing) scripts to enhance the functionality of Nmap. Written in Lua, these scripts can be used for a variety of purposes such as advanced version detection, vulnerability detection, or even more complex tasks.

- **Default Safe Scripts**:
  ```bash
  nmap -sC <target>
  ```

- **Specific Script**:
  ```bash
  nmap --script=<script-name> <target>
  ```

- **Categories**:
  There are many script categories available like `auth`, `brute`, `discovery`, etc. Example:
  ```bash
  nmap --script=discovery <target>
  ```

### NSE Basics:

 1.- Location: NSE scripts have a .nse extension and are usually located in the /scripts/ directory of the Nmap installation. NSE libraries, which are Lua modules that can be imported by NSE scripts, reside in the /nselib/ directory.

 2.- Script Categories: NSE scripts are divided into categories like:

    - auth: Scripts that deal with authentication.
    - broadcast: Discover hosts using broadcast.
    - brute: Brute force attacks.
    - discovery: Discover services running on target hosts.
    ... (and more)

 3.- Usage:
    To run a specific script:
```bash
nmap --script <script-name> <target>
```
To run all scripts in a category:
```
nmap --script=<category-name> <target>
```

### Writing a Basic NSE Script:

- Header: Each NSE script starts with a header section containing important meta-information like the script's name, category, and dependencies.

- Rule Functions: These determine when the action function of the script should be run:

 - portrule: Determines on which ports the script should run.
 - hostrule: Determines on which hosts the script should run.
... (and more)

- Action Function: This is where the main functionality of the script resides. It's executed when the rule functions (like portrule or hostrule) return true.

### Basic NSE Script Example:
Here's a simple script that checks if a given port is open:

```lua
description = [[
   Simple script to check if a port is open.
]]

-- Define the rule for which ports the script should be run on
portrule = function(host, port)
   return port.number == 80 -- run the script for port 80
end

-- The main action of the script
action = function(host, port)
   if nmap.get_port_state(host, port) then
      return "Port " .. port.number .. " is open"
   else
      return "Port " .. port.number .. " is closed"
   end
end
```

To use this script:

Save it as port_check.nse.

```bash
nmap --script=./port_check.nse <target>
```

## 9. Output

- **Standard Output**:
  ```bash
  nmap -oN outputfile.txt <target>
  ```

- **XML Output**:
  ```bash
  nmap -oX outputfile.xml <target>
  ```

## Tips:

1. **Always respect legal and ethical guidelines**. Never scan networks or systems without explicit permission.
2. **Stealthy scans**: The less aggressive you make your scan (e.g., fewer ports, slower speed), the less likely you are to trigger alarms.
3. **Stay Updated**: Regularly update Nmap and its scripts (`nmap --script-updatedb`) to ensure you have the latest techniques and signatures.

## Resources:
- Nmap Official Documentation: https://nmap.org/book/man.html
- Nmap Scripting Engine (NSE): https://nmap.org/book/nse.html

Now you're equipped with the essential knowledge on Nmap. With hands-on practice and experience in real-life or lab scenarios, you can become proficient in its use for penetration testing. Remember to always use tools ethically and responsibly!
